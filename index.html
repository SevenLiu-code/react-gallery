<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>react画廊特效</title>
	<link rel="stylesheet" type="text/css" href="./style/reset.css">
	<link rel="stylesheet" type="text/css" href="./style/main.css">
	<script src="https://cdn.bootcss.com/react/15.4.2/react.min.js"></script>
	<script src="https://cdn.bootcss.com/react/15.4.2/react-dom.min.js"></script>
	<script src="https://cdn.bootcss.com/babel-standalone/6.22.1/babel.min.js"></script>

</head>
<body id="content" class="content">
	<script src="./script/data.js"></script>
	<script type="text/babel">
		// 创建图片url
		var imageDatas=(function createImgURL(data){
					var imgURLData=[];
					for (var i = 0; i < data.length; i++) {
						data[i].imgURL="./images/"+data[i].flieName;
						imgURLData.push(data[i]);
					};
					return imgURLData;
				})(datastr);

		function getRangeRandom(a, b){//生成一个随机数
			var max = Math.max(a, b),
				min = Math.min(a, b);
			return Math.floor(Math.random()*(max - min) + min);	
		};

		var ImageFigures = React.createClass({
			render: function(){
				var styleObj = {};
				if (this.props.arrange.pos){
					styleObj = this.props.arrange.pos;
				};
				return (
						<figure className="img-figure" style={styleObj}>
							<img src={this.props.data.imgURL} alt={this.props.data.title}/>
							<figcaption>
								<h2 className="img-title">{this.props.data.title}</h2>
							</figcaption>
						</figure>
					);
				}
		});

		var GalleryByReactApp = React.createClass({
			constant: {
				centerPos:{
					left: 0,
					top: 0
				},
				hPosRange: {//水平方向的取值范围
					leftSecX: [0, 0],
					rightSecX: [0, 0],
					y: [0, 0]
				},
				vPosRange: {//垂直方向的取值范围
					x: [0, 0],
					topY: [0, 0]
				}
			},
			getInitialState: function(){
				return {
					imgsArrangeArr: []
				}
			},
			componentDidMount: function(){//组件加载以后为每张图片计算的偏移范围
				var stageDOM = ReactDOM.findDOMNode(this.refs.stage),
					figureDOM = ReactDOM.findDOMNode(this.refs.imgFigure0);
				//拿到舞台的大小
				var stangeW = stageDOM.scrollWidth,
					stangeH = stageDOM.scrollHeight,
					halfStangeW = Math.ceil(stangeW/2),
					halfStangeH = Math.ceil(stangeH/2);
				//拿到figure的大小	
				var	figureW = figureDOM.scrollWidth,
					figureH = figureDOM.scrollHeight,
					halfFigureW = Math.ceil(figureW/2),
					halfFigureH = Math.ceil(figureH/2);
					console.log(figureH);
				//居中图片位置的设定
				this.constant.centerPos.left = halfStangeW  - halfFigureW;
				this.constant.centerPos.top = halfStangeH - halfFigureH;
				//水平方向的取值范围设定
				this.constant.hPosRange.leftSecX[0] = -halfFigureW;
				this.constant.hPosRange.leftSecX[1] = halfStangeW - halfFigureW*3;
				this.constant.hPosRange.rightSecX[0] = halfStangeW + halfFigureW;
				this.constant.hPosRange.rightSecX[1] = stangeW - halfFigureW;
				this.constant.hPosRange.y[0] = -halfFigureH;
				this.constant.hPosRange.y[1] = stangeH - halfFigureH;
				//垂直方向的取值范围设定
				this.constant.vPosRange.x[0] = halfStangeW - stangeW;
				this.constant.vPosRange.x[1] = halfStangeW;
				this.constant.vPosRange.topY[0] = -halfFigureH;
				this.constant.vPosRange.topY[1] = halfStangeH-figureH;

			    this.rearrange(0);
			},
			rearrange: function(centerIndex){//重新排序图片
				var imgsArrangeArr = this.state.imgsArrangeArr;//存放的是所有图片的position位置

				var constant = this.constant,
					centerPos = constant.centerPos,
					hPosRange = constant.hPosRange,
					vPosRange = constant.vPosRange,
					hPosRangeLeftSecX = hPosRange.leftSecX,
					hPosRangeRightSecX = hPosRange.rightSecX,
					hPosRangeY = hPosRange.y,
					vPosRangeX = vPosRange.x,
					vPosRangeTopY = vPosRange.topY,

					imgsArrangeTopArr = [],
					topImgNub = Math.round(Math.random()),//取一个或者不取
					topImgSpliceIndex = 0,
					imgsArrangeCenterArr = imgsArrangeArr.splice(centerIndex, 1);//取出中心图片的位置信息

					//居中centerIndex的图片
					imgsArrangeCenterArr[0].pos = centerPos;

					//取出要布局上侧图片的位置信息
					topImgSpliceIndex = Math.floor(Math.random() * (imgsArrangeArr.length - topImgNub));//随机取一个图片得到的index
					imgsArrangeTopArr = imgsArrangeArr.splice(topImgSpliceIndex, topImgNub);
					//布局位于上侧的图片
					imgsArrangeTopArr.forEach(function(value, index){
						imgsArrangeTopArr[index].pos = {
							left: getRangeRandom(vPosRangeX[0], vPosRangeX[1]),
							top: getRangeRandom(vPosRangeTopY[0], vPosRangeTopY[1])
						}
					});
					for (var i = 0, j = imgsArrangeArr.length, k = j/2; i < j;  i++) {
						var hPosRangeLORX = null;
						if (i < k) {//前半部布局在左边,后半部布局在右边,生成随机位置
							hPosRangeLORX = hPosRangeLeftSecX;
						}else {
							hPosRangeLORX = hPosRangeRightSecX;
						};
						imgsArrangeArr[i].pos = {
								left: getRangeRandom(hPosRangeLORX[0], hPosRangeLORX[1]),
								top: getRangeRandom(hPosRangeY[0], hPosRangeY[1])
							};
					};
					//把上侧图片和中心图片的信息再添加到imgsArrangeArr
					if (imgsArrangeTopArr && imgsArrangeTopArr[0] ) {
						imgsArrangeArr.splice(topImgSpliceIndex, 0, imgsArrangeTopArr[0]);
					};
					imgsArrangeArr.splice(centerIndex, 0, imgsArrangeCenterArr[0]);
					//更改state状态，state一当改变，立即重新渲染页面
					this.setState({
						imgsArrangeArr : imgsArrangeArr
					});
			},
			render: function(){
				var controllerUnits = [], imgFigures = [];

				imageDatas.forEach(function(value, index){
					if (!this.state.imgsArrangeArr[index]) {
						this.state.imgsArrangeArr[index] = {
							pos: {
								left: 0,
								top: 0
							}
						}
					};
				  imgFigures.push(<ImageFigures data={value} ref={"imgFigure" + index} arrange={this.state.imgsArrangeArr[index]}/>);
				}.bind(this));	

				return(
					<section className="stage" ref="stage">
						<section className="img-sec">
							{imgFigures}
						</section>
						<nav className="controller-nav">
							{controllerUnits}
						</nav>
					</section>
				);
	  	  	}
		});
		ReactDOM.render(
			<GalleryByReactApp />,
			document.getElementById("content")
			);
	</script>
</body>
</html>